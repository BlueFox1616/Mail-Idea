let tokenClient;

// Load Google API and Identity Services
async function initGoogleAPI() {
    console.log("Loading Google APIs...");

    // Load Google Identity Services
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: "609769740177-14dcsedrjlasnnni0m2lbu73bqt2bct8.apps.googleusercontent.com",
        scope: "https://www.googleapis.com/auth/gmail.readonly",
        callback: async (response) => {
            if (response.error) {
                console.error("Authentication error:", response);
                return;
            }
            console.log("User signed in. Token received.");
            await fetchEmails();
        },
    });

    // Load Gmail API
    await new Promise((resolve) => gapi.load("client", resolve));
    await gapi.client.load("https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest");

    console.log("Google APIs loaded.");
}

// Handle sign-in
const signInWithGoogle = () => tokenClient.requestAccessToken();

// Fetch emails
async function fetchEmails() {
    try {
        console.log("Fetching emails...");
        const response = await gapi.client.gmail.users.messages.list({
            userId: "me",
            maxResults: 10,
        });
        const messages = response.result.messages || [];
        console.log("Emails:", messages.length ? messages.map(msg => msg.id) : "No messages found.");
    } catch (error) {
        console.error("Error fetching messages:", error);
    }
}

// Initialize on page load
window.onload = async () => {
    await initGoogleAPI();
    google.accounts.id.renderButton(
        document.getElementById("g-signin-btn"),
        { theme: "outline", size: "large" }
    );
};
